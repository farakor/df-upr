# Рефакторинг привязки складов к меню

## Описание изменений

Изменена логика привязки складов и меню: **теперь склады привязываются к меню целиком, а не к отдельным позициям меню**.

## Технические изменения

### 1. База данных

#### Удалена таблица `warehouse_menu_items`
- Хранила привязку складов к позициям меню
- Поля: `warehouse_id`, `menu_item_id`, `is_available`, `price_override`

#### Создана таблица `warehouse_menus`
- Хранит привязку складов к меню целиком
- Поля:
  - `warehouse_id` - ID склада
  - `menu_id` - ID меню
  - `is_active` - активность привязки
  - `created_at`, `updated_at` - временные метки

#### Миграция
- Файл: `20251005153300_change_warehouse_menu_to_menu_level/migration.sql`
- Автоматически удаляет старую таблицу и создает новую
- **Внимание**: все существующие привязки будут удалены

### 2. Backend (API)

#### Изменения в `menu.service.ts`

**Удалены методы:**
- `addWarehouseMenuItem()`
- `updateWarehouseMenuItem()`
- `removeWarehouseMenuItem()`

**Добавлены методы:**
- `addWarehouseMenu(data)` - привязка меню к складу
- `getWarehouseMenus(warehouseId)` - получение меню склада
- `updateWarehouseMenu(warehouseId, menuId, data)` - обновление привязки
- `removeWarehouseMenu(warehouseId, menuId)` - отвязка меню от склада

**Обновлен метод:**
- `getAvailableMenu(warehouseId)` - теперь ищет позиции меню через привязанные к складу меню

#### Изменения в `menu.controller.ts`

Контроллер обновлен в соответствии с новыми методами сервиса.

#### Изменения в `menu.routes.ts`

**Новые эндпоинты:**
- `POST /api/menu/warehouse-menus` - привязать меню к складу
- `GET /api/menu/warehouses/:warehouseId/menus` - получить меню склада
- `PUT /api/menu/warehouses/:warehouseId/menus/:menuId` - обновить привязку
- `DELETE /api/menu/warehouses/:warehouseId/menus/:menuId` - отвязать меню

**Удалены эндпоинты:**
- `POST /api/menu/warehouse-items`
- `PUT /api/menu/warehouses/:warehouseId/items/:menuItemId`
- `DELETE /api/menu/warehouses/:warehouseId/items/:menuItemId`

#### Изменения в `menu.validation.ts`

**Схема `warehouseMenuItemSchema`:**
```typescript
{
  warehouseId: number (обязательно)
  menuId: number (обязательно)  // было: menuItemId
  isActive: boolean (опционально)  // было: isAvailable, priceOverride
}
```

### 3. Frontend

#### Изменения в `services/api/menu.ts`

**Новые методы API:**
- `addWarehouseMenu(data)`
- `getWarehouseMenus(warehouseId)`
- `updateWarehouseMenu(warehouseId, menuId, data)`
- `removeWarehouseMenu(warehouseId, menuId)`

**Новый интерфейс:**
```typescript
interface WarehouseMenuData {
  warehouseId: number;
  menuId: number;
  isActive?: boolean;
}
```

#### Изменения в `hooks/useMenu.ts`

Добавлены методы для работы с привязкой меню к складам:
- `addWarehouseMenu()`
- `getWarehouseMenus()`
- `updateWarehouseMenu()`
- `removeWarehouseMenu()`

#### Полностью переписан `pages/Menu/WarehouseMenuPage.tsx`

Новая функциональность:
- Выбор склада из списка
- Отображение всех меню, привязанных к складу
- Добавление меню к складу (выбор из доступных меню)
- Активация/деактивация меню на складе
- Отвязка меню от склада
- Отображение количества позиций в каждом меню
- Отображение периода действия меню

## Преимущества новой архитектуры

1. **Упрощенное управление**: Привязка целого меню проще, чем привязка каждой позиции отдельно
2. **Гибкость**: Можно быстро активировать/деактивировать целое меню на складе
3. **Масштабируемость**: Легче управлять меню с большим количеством позиций
4. **Логичность**: Меню как логическая единица привязывается к точке продаж
5. **Производительность**: Меньше записей в БД, меньше запросов

## Миграция данных

После применения миграции необходимо:

1. Создать меню в системе (если еще не созданы)
2. Привязать позиции меню к созданным меню
3. Привязать меню к складам через новый интерфейс "Настройка меню по складам"

## Обратная совместимость

⚠️ **Внимание**: Старые данные о привязках будут потеряны при миграции.

После обновления необходимо заново настроить привязки меню к складам.

## Инструкция по использованию

### Для администраторов

1. Перейдите в раздел "Меню" → "Настройка меню по складам"
2. Выберите склад из списка
3. Нажмите "Добавить меню"
4. Выберите меню из списка доступных
5. Меню будет привязано к складу и автоматически активировано

### Управление привязками

- **Активация/деактивация**: Нажмите кнопку "Активировать"/"Деактивировать" рядом с меню
- **Удаление привязки**: Нажмите кнопку с иконкой корзины
- **Просмотр позиций**: Количество позиций отображается в badge рядом с названием меню

## Проверка работоспособности

1. Создайте тестовое меню с несколькими позициями
2. Привяжите меню к складу
3. Проверьте отображение в разделе "Меню" для этого склада
4. Деактивируйте меню и убедитесь, что оно не отображается
5. Удалите привязку

## Дата изменений

5 октября 2025 года

## Миграция
- Файл миграции: `20251005153300_change_warehouse_menu_to_menu_level`
