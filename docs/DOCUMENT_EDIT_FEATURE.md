# Функция редактирования документов

## Обзор

Реализована полная функциональность редактирования складских документов через удобный интерфейс.

## Возможности

### 1. Редактирование основной информации документа
- Изменение даты документа
- Изменение поставщика (для приходов)
- Изменение складов (откуда/куда)
- Изменение примечаний

### 2. Управление позициями документа
- **Добавление позиций**: добавление новых товаров в документ
- **Удаление позиций**: удаление существующих позиций
- **Просмотр позиций**: таблица со всеми позициями документа

### 3. Автоматические функции
- Автоматический расчет суммы по позициям
- Автоматический выбор единицы измерения при выборе товара
- Валидация всех полей формы
- Обновление данных после сохранения

## Компоненты

### DocumentEditDialog
**Расположение**: `/client/src/components/common/DocumentEditDialog.tsx`

**Props**:
- `documentId: number | null` - ID редактируемого документа
- `open: boolean` - флаг открытия диалога
- `onClose: () => void` - callback при закрытии
- `onSuccess?: () => void` - callback при успешном сохранении

**Особенности**:
- Загрузка данных документа при открытии
- Предзаполнение формы существующими данными
- Поддержка всех типов документов (приход, перемещение, списание, корректировка)
- Валидация полей с помощью Zod
- Обработка ошибок и состояний загрузки

## Использование

### Открытие диалога редактирования
```tsx
const [editingDocumentId, setEditingDocumentId] = useState<number | null>(null);

// Открыть диалог
const handleEditDocument = (id: number) => {
  setEditingDocumentId(id);
};

// Компонент
<DocumentEditDialog
  documentId={editingDocumentId}
  open={editingDocumentId !== null}
  onClose={() => setEditingDocumentId(null)}
  onSuccess={() => {
    // Дополнительные действия после сохранения
    setEditingDocumentId(null);
  }}
/>
```

## Ограничения

- Редактирование доступно **только для документов в статусе "Черновик"**
- После проведения документа редактирование недоступно
- Нельзя изменить тип документа (приход, перемещение и т.д.)
- Нельзя изменить номер документа

## Валидация

### Основная форма
- **Дата документа**: обязательное поле
- **Поставщик**: обязательно для приходов
- **Склад откуда**: обязательно для перемещений и списаний
- **Склад куда**: обязательно для приходов и перемещений

### Позиции документа
- **Товар**: обязательное поле
- **Количество**: обязательное поле, должно быть больше 0
- **Единица измерения**: обязательное поле
- **Цена**: обязательное поле, должна быть больше 0
- **Номер партии**: опционально
- **Срок годности**: опционально

## API эндпоинты

### Обновление документа
```
PUT /api/documents/:id
Body: {
  date?: string,
  supplierId?: number,
  warehouseFromId?: number,
  warehouseToId?: number,
  notes?: string
}
```

### Добавление позиции
```
POST /api/documents/:documentId/items
Body: {
  productId: number,
  quantity: number,
  unitId: number,
  price: number,
  expiryDate?: string,
  batchNumber?: string
}
```

### Удаление позиции
```
DELETE /api/documents/:documentId/items/:itemId
```

## Технические детали

### Используемые хуки
- `useDocument(id)` - загрузка данных документа
- `useUpdateDocument()` - обновление документа
- `useAddDocumentItem()` - добавление позиции
- `useRemoveDocumentItem()` - удаление позиции
- `useSuppliers()` - список поставщиков
- `useWarehouses()` - список складов
- `useProducts()` - список товаров
- `useUnits()` - список единиц измерения

### Библиотеки валидации
- **Zod** - схемы валидации
- **react-hook-form** - управление формами
- **@hookform/resolvers/zod** - интеграция Zod с react-hook-form

### UI компоненты
- Dialog - модальное окно
- Card - карточки для группировки полей
- Select - выбор из списка
- Input - текстовые поля
- Calendar - выбор даты
- AlertDialog - подтверждение удаления

## Тестирование

### Сценарии для проверки

1. **Редактирование даты документа**
   - Открыть документ в статусе "Черновик"
   - Изменить дату
   - Сохранить
   - Проверить, что дата обновилась

2. **Добавление позиции**
   - Открыть редактирование
   - Нажать "Добавить позицию"
   - Заполнить все поля
   - Сохранить позицию
   - Проверить, что позиция добавлена и сумма пересчитана

3. **Удаление позиции**
   - Открыть редактирование
   - Нажать кнопку удаления у позиции
   - Подтвердить удаление
   - Проверить, что позиция удалена и сумма пересчитана

4. **Валидация**
   - Попробовать сохранить без обязательных полей
   - Проверить, что показываются ошибки
   - Попробовать ввести отрицательные значения
   - Проверить, что показываются ошибки

5. **Отмена изменений**
   - Внести изменения
   - Нажать "Отмена"
   - Проверить, что изменения не сохранились

## Дальнейшие улучшения

- [ ] Редактирование существующих позиций (сейчас можно только добавлять/удалять)
- [ ] Массовое добавление позиций из Excel
- [ ] История изменений документа
- [ ] Комментарии к изменениям
- [ ] Прикрепление файлов к документу
- [ ] Печать документа
- [ ] Экспорт в PDF

## Дата реализации

5 октября 2025 года
