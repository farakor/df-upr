# ✅ Исправление: Товары не отображаются при добавлении позиции в документ прихода

## Дата исправления
5 октября 2025

## Обновление
5 октября 2025 - Добавлено модальное окно для формы добавления позиции

## Проблема
При добавлении прихода товара в поле "Товар" при добавлении позиции документа не отображался список товаров из номенклатуры.

## Причина
Несоответствие структуры данных API и обращения к ним в компонентах:
- API возвращает структуру `ProductsResponse` с полем `products`
- В компонентах использовалось обращение `products?.data` вместо `products?.products`

## Структура данных ProductsResponse
```typescript
export interface ProductsResponse {
  products: Product[];  // ← Правильное поле
  total: number;
  page: number;
  totalPages: number;
}
```

## Исправленные файлы

### 1. `/client/src/components/forms/DocumentForm.tsx`

**Строка 69:** Добавлен фильтр для отображения только активных товаров
```typescript
// Было:
const { data: products } = useProducts();

// Стало:
const { data: products } = useProducts({ isActive: true }); // Показываем только активные товары
```

**Строка 180:** Исправлено обращение к данным в функции getProduct
```typescript
// Было:
const getProduct = (productId: number) => products?.data?.find(p => p.id === productId);

// Стало:
const getProduct = (productId: number) => products?.products?.find(p => p.id === productId);
```

**Строки 402-406:** Исправлено обращение к данным в Select компоненте
```typescript
// Было:
{products?.data?.map((product) => (
  <SelectItem key={product.id} value={product.id.toString()}>
    {product.name} {product.article && `(${product.article})`}
  </SelectItem>
))}

// Стало:
{products?.products?.map((product) => (
  <SelectItem key={product.id} value={product.id.toString()}>
    {product.name} {product.article && `(${product.article})`}
  </SelectItem>
))}
```

### 2. `/client/src/pages/StockMovements/StockMovementsPage.tsx`

**Строка 133:** Исправлено обращение к данным в фильтре товаров
```typescript
// Было:
{products?.data?.slice(0, 50).map((product) => (

// Стало:
{products?.products?.slice(0, 50).map((product) => (
```

## Дополнительные улучшения

1. **Фильтрация активных товаров**: Теперь в форме документа отображаются только активные товары (`isActive: true`), что предотвращает добавление неактивных товаров в новые документы.

2. **Согласованность структуры данных**: Проверена и исправлена согласованность использования `products?.products` во всех местах кода.

## Примечание о других сущностях

Структура данных для других сущностей остается без изменений:
- `SuppliersResponse` использует поле `data` - это правильно
- `useSuppliers()` возвращает структуру с полем `data`
- Обращение `suppliers?.data` остается корректным

## Дополнительное исправление: Вложенные формы

### Проблема #2
После первого исправления выявилась еще одна проблема: при нажатии кнопки "Добавить" в форме позиции, всё исчезало и происходил возврат на страницу "Приход товаров".

### Причина #2
Форма добавления позиции находилась **внутри** основной формы документа (вложенные формы). Это приводило к тому, что при отправке формы позиции также отправлялась основная форма документа, что вызывало преждевременное закрытие всей формы.

### Решение #2
**Строки 385-536:** Форма добавления позиции перенесена **за пределы** основной формы документа

```typescript
// Было (неправильная структура):
<form onSubmit={handleSubmit(handleFormSubmit)}>
  {/* Основная форма документа */}
  
  {/* Форма добавления позиции - ВНУТРИ основной формы ❌ */}
  {showItemForm && (
    <form onSubmit={handleSubmitItem(handleAddItem)}>
      {/* Поля формы позиции */}
    </form>
  )}
  
  {/* Кнопки управления документом */}
</form>

// Стало (правильная структура):
<form onSubmit={handleSubmit(handleFormSubmit)}>
  {/* Основная форма документа */}
  
  {/* Кнопки управления документом */}
</form>

{/* Форма добавления позиции - ВНЕ основной формы ✅ */}
{showItemForm && (
  <form onSubmit={handleSubmitItem(handleAddItem)}>
    {/* Поля формы позиции */}
  </form>
)}
```

### Важно
В HTML **вложенные формы не допускаются**. Когда форма находится внутри другой формы, это приводит к непредсказуемому поведению при отправке данных.

## Улучшение #3: Модальное окно для добавления позиции

### Проблема UX
После исправления вложенных форм форма добавления позиции отображалась внизу страницы, что было неудобно:
- Приходилось прокручивать страницу вниз
- Форма могла выходить за пределы видимой области
- Не было четкого визуального разделения между основной формой и формой позиции

### Решение #3
Форма добавления/редактирования позиции теперь открывается в **модальном окне (Dialog)**.

**Изменения:**

1. **Импорт Dialog компонента** (строка 18):
```typescript
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/Dialog';
```

2. **Обработчик закрытия модального окна** (строки 154-160):
```typescript
const handleCloseItemForm = (open: boolean) => {
  setShowItemForm(open);
  if (!open) {
    setEditingItem(null);
    resetItem();
  }
};
```

3. **Обертка формы в Dialog** (строки 406-544):
```typescript
<Dialog open={showItemForm} onOpenChange={handleCloseItemForm}>
  <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
    <DialogHeader>
      <DialogTitle>{editingItem ? 'Редактировать позицию' : 'Добавить позицию'}</DialogTitle>
    </DialogHeader>
    
    <form onSubmit={handleSubmitItem(handleAddItem)}>
      {/* Поля формы */}
    </form>
  </DialogContent>
</Dialog>
```

### Преимущества модального окна:
- ✅ **Удобство**: Форма всегда в центре экрана, не требует прокрутки
- ✅ **Фокус**: Затемнение фона привлекает внимание к форме
- ✅ **Адаптивность**: Размер `max-w-3xl` и `max-h-[90vh]` обеспечивает комфортный просмотр на любых экранах
- ✅ **UX**: Возможность закрыть по клику вне формы или по Escape
- ✅ **Прокрутка**: При большом количестве полей внутри модального окна работает прокрутка (`overflow-y-auto`)

## Результат
✅ Теперь при добавлении позиции в документ прихода товара:
1. В поле "Товар" корректно отображается список всех активных товаров из раздела номенклатуры
2. Форма добавления позиции открывается в **удобном модальном окне** по центру экрана
3. При нажатии "Добавить" позиция добавляется в список, а модальное окно закрывается
4. Основная форма документа остается открытой, позволяя добавить больше позиций или завершить создание документа
5. Можно закрыть модальное окно кликом вне его или нажатием Escape

## Проверка работоспособности
Для проверки всех исправлений и улучшений:

1. Перейдите в раздел **"Документы"** → **"Приход товара"**
2. Нажмите **"Добавить приход"**
3. Заполните основную информацию (дату, поставщика, склад)
4. Нажмите **"Добавить позицию"**
5. ✅ Должно открыться **модальное окно** по центру экрана с затемненным фоном
6. В поле **"Товар"** выберите товар из списка
7. ✅ Список должен содержать **только активные товары** из номенклатуры
8. ✅ **Единица измерения** должна автоматически установиться в соответствии с товаром
9. Заполните количество и цену
10. ✅ Внизу формы должна отображаться **автоматически рассчитанная сумма**
11. Нажмите **"Добавить"**
12. ✅ Позиция должна появиться в списке позиций документа
13. ✅ Модальное окно должно закрыться
14. ✅ Основная форма документа должна остаться открытой
15. Попробуйте нажать **"Добавить позицию"** снова
16. Попробуйте закрыть модальное окно:
    - Нажмите кнопку **"Отмена"** ✅
    - Кликните **вне модального окна** ✅
    - Нажмите клавишу **Escape** ✅
17. Добавьте несколько позиций и нажмите **"Создать документ"**
18. ✅ Документ должен успешно создаться со всеми позициями

## Технические детали

### Применяется ко всем типам документов:
- ✅ Приход товара (RECEIPT)
- ✅ Перемещение товара (TRANSFER)
- ✅ Списание товара (WRITEOFF)
- ✅ Корректировка остатков (INVENTORY_ADJUSTMENT)

### Исправленные файлы:
1. `/client/src/components/forms/DocumentForm.tsx` - основная форма документа
2. `/client/src/pages/StockMovements/StockMovementsPage.tsx` - фильтр товаров

### Связанные файлы (используются без изменений):
- `/client/src/pages/Documents/ReceiptPage.tsx`
- `/client/src/pages/Documents/TransferPage.tsx`
- `/client/src/pages/Documents/WriteoffPage.tsx`
- `/client/src/hooks/useProducts.ts`
- `/client/src/services/api/products.ts`
- `/client/src/types/nomenclature.ts`
