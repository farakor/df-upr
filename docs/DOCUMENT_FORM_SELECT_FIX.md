# ✅ Исправление: Единицы измерения не сохраняются при добавлении позиций

## Дата исправления
5 октября 2025

## Проблема
При добавлении позиции в документ прихода товара:
- Единица измерения автоматически устанавливалась при выборе товара
- Но визуально **не отображалась** в выпадающем списке
- Из-за этого казалось, что единица измерения не сохраняется

## Причина
В компонентах `Select` для товара и единицы измерения не было установлено свойство `value`, которое контролирует отображение текущего выбранного значения.

### Как работает Select в React:
```typescript
// ❌ Неконтролируемый компонент (проблема)
<Select onValueChange={handleChange}>
  {/* Select не знает, что выбрано */}
</Select>

// ✅ Контролируемый компонент (правильно)
<Select value={currentValue} onValueChange={handleChange}>
  {/* Select отображает выбранное значение */}
</Select>
```

## Решение

### Файл: `/client/src/components/forms/DocumentForm.tsx`

**1. Добавлено отслеживание единицы измерения** (строка 102):
```typescript
const watchedItemUnitId = watchItem('unitId');
```

**2. Добавлен контроль для Select товара** (строки 418-421):
```typescript
// Было:
<Select onValueChange={(value) => setValueItem('productId', parseInt(value))}>

// Стало:
<Select 
  value={watchedItemProductId?.toString()} 
  onValueChange={(value) => setValueItem('productId', parseInt(value))}
>
```

**3. Добавлен контроль для Select единицы измерения** (строки 441-444):
```typescript
// Было:
<Select onValueChange={(value) => setValueItem('unitId', parseInt(value))}>

// Стало:
<Select 
  value={watchedItemUnitId?.toString()} 
  onValueChange={(value) => setValueItem('unitId', parseInt(value))}
>
```

## Что изменилось

### До исправления ❌
1. Выбираешь товар → единица измерения устанавливается автоматически
2. Но в поле единицы измерения **ничего не отображается** (выглядит пустым)
3. Создается впечатление, что единица измерения не сохранена
4. При редактировании позиции поля товара и единицы измерения **пустые**

### После исправления ✅
1. Выбираешь товар → единица измерения устанавливается автоматически
2. В поле единицы измерения **сразу отображается** выбранная единица
3. Визуально понятно, какая единица измерения установлена
4. При редактировании позиции поля товара и единицы измерения **заполнены** правильными значениями
5. Можно вручную изменить единицу измерения, если нужно

## Технические детали

### Контролируемые компоненты в React Hook Form

React Hook Form использует паттерн **контролируемых компонентов** для отслеживания состояния формы:

```typescript
// Отслеживание значений
const watchedValue = watchItem('fieldName');

// Отображение в компоненте
<Select value={watchedValue?.toString()} onValueChange={setValue}>
```

### Преобразование типов

Важно преобразовывать числовые ID в строки для `value`:
```typescript
value={watchedItemUnitId?.toString()}  // number → string
```

И обратно при изменении:
```typescript
onValueChange={(value) => setValueItem('unitId', parseInt(value))}  // string → number
```

### Optional chaining

Используется `?.toString()` для безопасного преобразования, если значение `undefined`:
```typescript
value={watchedItemUnitId?.toString()}  // undefined → undefined (не вызывает ошибку)
```

## Результат

✅ **Единицы измерения теперь:**
- Автоматически устанавливаются при выборе товара
- **Визуально отображаются** в выпадающем списке
- Правильно сохраняются при добавлении позиции
- Корректно отображаются при редактировании позиции

## Проверка работоспособности

1. Перейдите в раздел **"Документы"** → **"Приход товара"**
2. Нажмите **"Создать документ прихода"**
3. Заполните основную информацию
4. Нажмите **"Добавить позицию"**
5. Выберите **товар** из списка
6. ✅ В поле **"Единица измерения"** должна автоматически отобразиться единица измерения товара
7. ✅ Единица измерения должна быть **видна** в выпадающем списке
8. Заполните количество и цену
9. Нажмите **"Добавить"**
10. ✅ Позиция добавляется с правильной единицей измерения
11. Нажмите **"Изменить"** на добавленной позиции
12. ✅ В модальном окне поля **товар** и **единица измерения** должны быть **заполнены**

## Связанные исправления

Это исправление дополняет серию улучшений формы документов:

1. ✅ Отображение товаров в списке (products?.products)
2. ✅ Вынос формы позиции за пределы основной формы
3. ✅ Модальное окно для формы позиции
4. ✅ **Отображение выбранных значений в Select** (текущее)

Полная документация: `/docs/DOCUMENT_FORM_PRODUCTS_FIX.md`

---

**Тип исправления:** Визуальное отображение (данные сохранялись корректно)  
**Затронутые компоненты:** Select для товара и единицы измерения  
**Совместимость:** Все типы документов (RECEIPT, TRANSFER, WRITEOFF, INVENTORY_ADJUSTMENT)
